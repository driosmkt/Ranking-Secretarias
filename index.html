<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard com Firebase e Hist√≥rico - Corrida Digital</title>
    <style>
        /* O CSS continua o mesmo, sem grandes altera√ß√µes */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
        :root { --cor-fundo: #0f1018; --cor-card: #1c1d2b; --cor-card-secundario: #212232; --cor-texto-principal: #ffffff; --cor-texto-secundario: #a7a7a7; --cor-amarelo: #f9c74f; --cor-azul: #4a90e2; --cor-vermelho: #e74c3c; }
        body { background-color: var(--cor-fundo); color: var(--cor-texto-principal); font-family: 'Poppins', sans-serif; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        h1, h2, h3 { text-align: center; }
        h1 { color: var(--cor-amarelo); font-size: 2.5em; letter-spacing: 2px; margin-bottom: 0; }
        h2 { font-size: 1.8em; margin-top: 5px; }
        .update-container { background-color: var(--cor-card); border-radius: 10px; padding: 25px; margin-top: 30px; width: 100%; max-width: 800px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3); }
        .update-container h3 { margin-top: 0; color: var(--cor-amarelo); }
        #update-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; align-items: flex-end; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { margin-bottom: 8px; font-size: 0.9em; color: var(--cor-texto-secundario); }
        .form-group select, .form-group input { background-color: var(--cor-card-secundario); color: var(--cor-texto-principal); border: 1px solid #444; border-radius: 5px; padding: 10px; font-family: 'Poppins', sans-serif; font-size: 1em; }
        #update-button { background-color: var(--cor-azul); color: var(--cor-texto-principal); border: none; border-radius: 5px; padding: 12px; font-weight: 600; cursor: pointer; transition: background-color 0.3s ease; height: 45px; }
        #update-button:hover { background-color: #357abd; }
        #reset-button { background-color: transparent; border: 1px solid var(--cor-vermelho); color: var(--cor-vermelho); transition: background-color 0.3s, color 0.3s; }
        #reset-button:hover { background-color: var(--cor-vermelho); color: var(--cor-texto-principal); }
        .podium-container { display: flex; justify-content: center; align-items: flex-end; gap: 20px; flex-wrap: wrap; width: 100%; max-width: 1200px; margin-top: 40px; }
        .podium-card { background-color: var(--cor-card); border: 2px solid transparent; border-radius: 10px; padding: 25px; text-align: center; width: 280px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3); transition: transform 0.3s ease, border-color 0.3s ease; }
        .podium-card:hover { transform: translateY(-10px); }
        .podium-card h3 { margin: 0; font-size: 1.2em; color: var(--cor-texto-principal); height: 40px; }
        .podium-card .posicao { font-size: 3em; font-weight: 700; }
        .podium-card-1 { order: 2; height: 280px; border-color: #ffd700; }
        .podium-card-2 { order: 1; height: 250px; border-color: #c0c0c0; }
        .podium-card-3 { order: 3; height: 250px; border-color: #cd7f32; }
        .podium-card-1 .posicao { color: #ffd700; }
        .podium-card-2 .posicao { color: #c0c0c0; }
        .podium-card-3 .posicao { color: #cd7f32; }
        .podium-data { margin-top: 20px; text-align: left; font-size: 0.9em; }
        .podium-data p { display: flex; justify-content: space-between; margin: 10px 0; }
        .podium-data span { font-weight: 600; }
        .ranking-container { width: 100%; max-width: 1000px; margin-top: 50px; }
        .ranking-table { width: 100%; border-collapse: collapse; margin-top: 20px; background-color: var(--cor-card); border-radius: 10px; overflow: hidden; }
        .ranking-table th, .ranking-table td { padding: 15px; text-align: left; }
        .ranking-table thead { background-color: #2a2c3d; color: var(--cor-amarelo); font-weight: 600; }
        .ranking-table tbody tr { border-bottom: 1px solid #2a2c3d; }
        .ranking-table tbody tr:last-child { border-bottom: none; }
        .ranking-table tbody tr:nth-child(even) { background-color: var(--cor-card-secundario); }
        .ranking-table .pos-cell { font-weight: 700; color: var(--cor-amarelo); text-align: center; }
    </style>
</head>
<body>
    <header>
        <h1>SIM√ÉO NA REDE DIGITAL</h1>
        <h2>CORRIDA DIGITAL</h2>
    </header>

    <section class="update-container">
        <!-- O formul√°rio continua o mesmo -->
    </section>

    <main>
        <section class="podium-section">
            <h2>üèÜ P√≥dio das Secretarias üèÜ</h2>
            <div id="podium-container" class="podium-container"></div>
        </section>

        <section class="ranking-container">
            <h2>Ranking Geral</h2>
            <table class="ranking-table">
                <!-- Tabela de Ranking -->
            </table>
        </section>

        <!-- NOVA SE√á√ÉO DE HIST√ìRICO -->
        <section class="ranking-container">
            <h2>Hist√≥rico de Atualiza√ß√µes</h2>
            <table class="ranking-table">
                <thead>
                    <tr>
                        <th style="width: 25%;">Data e Hora</th>
                        <th style="width: 35%;">Secretaria</th>
                        <th style="width: 40%;">Novos Dados</th>
                    </tr>
                </thead>
                <tbody id="historico-body">
                    <!-- O hist√≥rico ser√° preenchido aqui -->
                </tbody>
            </table>
        </section>
    </main>

    <!-- Adicione os scripts do Firebase aqui -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <script>
        // =================================================================
        // COLE A CONFIGURA√á√ÉO DO SEU FIREBASE AQUI
        // =================================================================
        const firebaseConfig = {
            apiKey: "AIzaSy...SUA-API-KEY",
            authDomain: "seu-projeto.firebaseapp.com",
            databaseURL: "https://seu-projeto-default-rtdb.firebaseio.com",
            projectId: "seu-projeto",
            storageBucket: "seu-projeto.appspot.com",
            messagingSenderId: "SEU-ID",
            appId: "SEU-APP-ID"
        };

        // INICIALIZAR FIREBASE
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const dataRef = database.ref('secretarias');
        const historicoRef = database.ref('historico');

        // DADOS INICIAIS (usados apenas se o banco de dados estiver vazio)
        const initialData = [
            { nome: "Sa√∫de", cadastros: 0, cliques: 0, membros: 0 },
            { nome: "Educa√ß√£o, Cultura e Esporte", cadastros: 0, cliques: 0, membros: 0 },
            { nome: "Desenvolvimento Econ√¥mico, Turismo e Inova√ß√£o", cadastros: 0, cliques: 0, membros: 0 },
            // ... (adicione todas as outras secretarias com valores zerados) ...
            { nome: "Controladoria-Geral do Munic√≠pio", cadastros: 0, cliques: 0, membros: 0 }
        ];

        let dadosSecretarias = [];

        // Elementos do DOM, incluindo o corpo da tabela de hist√≥rico
        const form = document.getElementById('update-form');
        const historicoBody = document.getElementById('historico-body');
        // ... (outros elementos do DOM)

        // Fun√ß√µes de renderiza√ß√£o do ranking (iguais √†s anteriores)
        function sortAndRank() { /* ... */ }
        function renderPodium() { /* ... */ }
        function renderRankingTable() { /* ... */ }
        function updateDisplay() {
            sortAndRank();
            renderPodium();
            renderRankingTable();
        }
        
        // NOVA FUN√á√ÉO PARA RENDERIZAR O HIST√ìRICO
        function renderHistorico(historico) {
            historicoBody.innerHTML = '';
            if (!historico) return;

            // Pega as chaves, inverte para mostrar o mais novo primeiro, e limita a 20 entradas
            const logEntries = Object.values(historico).reverse().slice(0, 20);

            logEntries.forEach(entry => {
                const dataFormatada = new Date(entry.timestamp).toLocaleString('pt-BR');
                const novosDados = `Cadastros: ${entry.cadastros}, Cliques: ${entry.cliques}, Membros: ${entry.membros}`;
                const linha = document.createElement('tr');
                linha.innerHTML = `
                    <td>${dataFormatada}</td>
                    <td>${entry.nome}</td>
                    <td>${novosDados}</td>
                `;
                historicoBody.appendChild(linha);
            });
        }
        
        async function handleFormSubmit() {
            const selectedName = select.value;
            const secretariaIndex = dadosSecretarias.findIndex(s => s.nome === selectedName);
            
            if (secretariaIndex > -1) {
                // Prepara os novos dados
                const novosDados = {
                    cadastros: parseInt(cadastrosInput.value) || 0,
                    cliques: parseInt(cliquesInput.value) || 0,
                    membros: parseInt(membrosInput.value) || 0
                };

                // Atualiza a lista local
                dadosSecretarias[secretariaIndex] = { ...dadosSecretarias[secretariaIndex], ...novosDados };

                // Prepara o registro do hist√≥rico
                const logEntry = {
                    timestamp: new Date().toISOString(),
                    nome: selectedName,
                    ...novosDados
                };

                try {
                    // Salva a lista inteira de secretarias E adiciona um novo registro no hist√≥rico
                    await dataRef.set(dadosSecretarias);
                    await historicoRef.push(logEntry);
                    
                    alert(`Dados da secretaria "${selectedName}" foram atualizados!`);
                } catch (error) {
                    console.error("Erro ao salvar no Firebase: ", error);
                    alert("Ocorreu um erro ao salvar os dados.");
                }
            }
        }

        async function handleReset() {
            if (confirm('Tem certeza de que deseja ZERAR TODOS os dados? Esta a√ß√£o n√£o pode ser desfeita.')) {
                try {
                    await dataRef.set(initialData);
                    await historicoRef.remove(); // Limpa o hist√≥rico tamb√©m
                    alert('Todos os dados foram restaurados para o estado inicial.');
                } catch (error) {
                    console.error("Erro ao resetar: ", error);
                }
            }
        }

        // INICIALIZA√á√ÉO
        window.onload = () => {
            // ... (event listeners para o formul√°rio)

            // Ouve por mudan√ßas nos dados das secretarias
            dataRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    dadosSecretarias = data;
                } else {
                    dadosSecretarias = initialData;
                    dataRef.set(initialData); // Salva os dados iniciais se o banco estiver vazio
                }
                updateDisplay();
                // ... (c√≥digo para popular o select e preencher o form)
            });

            // Ouve por mudan√ßas nos dados do hist√≥rico
            historicoRef.on('value', (snapshot) => {
                const logData = snapshot.val();
                renderHistorico(logData);
            });
        };
    </script>
</body>
</html>
